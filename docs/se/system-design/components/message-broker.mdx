# Message Brokers

## Overview

A message broker is a software that routes messages between different applications, helping them communicate reliably and asynchronously.

Message brokers are the fundamental building block for any type of asynchronous software architecture.


## Features

Message brokers may provide **queues** and **topics**.

Message brokers provide capabilities that can be useful for asynchronous communication:
1. **Guaranteed Delivery**: Brokers ensure messages are reliably delivered to their destination, even if the downstream service is temporarily unavailable. They store messages in a durable manner until they can be processed.
2. **Message Order Guarantee**: Most brokers ensures that messages are delivered in the same order they were sent.
3. **Transactions on Write**: allow to write data to multiple topics in a single transactionn (e.g., Kafka).
4. **Read Transactionality**: prevents message loss in case the consumer fail to process it.
5. **Exactly-Once Delivery**: Guarantees that messages are delivered only once without duplication.

> [!CAUTION]
> While brokers may guarantee exactly once delivery, it is still recommended to design consumers to gracefully handle potential duplicate messages.


## Consumers

Consumers are entities that receive and process messages sent by a producer via the message broker.

Each instance of a microservice can be a consumer.

Multiple instances of the same microservice form a consumer group.


## Queues

A queue is a data structure used by message brokers to store messages.

Queues are typically point to point:
1. A sender puts a message on a queue, and a consumer reads from that queue.
2. The queue acts as an intermediary, ensuring that each message is consumed by only one consumer.
3. Once a consumer receives and processes the message, it is removed from the queue.

When a message is put into the queue, only one member of the consumer group will receive that message; the queue works as a load distribution mechanism.

![](./message-broker/queue.drawio.svg)

Example: RabbitMQ, Amazon SQS.


## Topics

Topics are channels where messages are published by producers.

Multiple consumers can subscribe to a topic and receive a copy of every message published to it.

If multiple consumer groups subscribe to a topic, within each consumer group, only one instance will see that message.

![](./message-broker/topic.drawio.svg)

> [!NOTE]
> Unlike queues, topics allow broadcasting messages to all subscribers rather than delivering messages to just one consumer.


## Benefits

Message brokers provide Quality Attributes:
1. **Fault Tolerance**:
   - It allows different services to communicate with each other while some of them may be unavailable temporarily
   - Message brokers prevent messages from being lost
2. **Availability & Scalability**:
   - A message broker can queue up messages when there is a traffic spike. It allows system to scale to high traffic without modification


## Message Brokers Solutions

Open Source Message Brokers:
- **Apache Kafka**. Most popular. Apache Kafka is a distributed event streaming platform for high-performance data pipelines, streaming analytics, data integration, and mission-critical applications.
- **RabbitMQ**. It is used worldwide at small startups and large enterprises.

Cloud Based Message Brokers:
- **Amazon Simple Queue Service (SQS)**. Message queuing service.
- **Google Cloud Pub/Sub**. Publisher/Subscriber and message queue solutions.
- **Microsoft Azure**:
   - **Service Bus**. message broker with message queues and publish-subscribe topics.
   - **Event Hubs**. real-time data ingestion service. Allows streaming millions of events per second from any source. Integrates seamlessly with Apache Kafka clients. A perfect solution for Big Data.
   - **Event Grid**. serverless event delivery system at a massive scale. It uses the publish-subscribe model.
