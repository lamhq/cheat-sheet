# Workspace

## Overview

PNPM Workspace is a feature that allows you to manage multiple interdependent packages within a single repository (monorepo).

It's ideal for projects that contain multiple apps, libraries, or services that share dependencies or tooling.

Below is the sample structure of a PNPM Workspace:

```
.
├── apps
│   ├── docs
│   │   └── package.json
│   └── web
│       └── package.json
├── packages
│   ├── ui
│   │   └── package.json
│   └── utils
│       └── package.json
├── package.json
├── pnpm-lock.yaml
└── pnpm-workspace.yaml
```


## Why Use Workspace?

- **Speed**: Faster installs than npm or Yarn due to content-addressable storage
- **Disk Efficiency**: Shared dependencies reduce duplication across packages
- **Local Linking**: Use `workspace:*` to link packages without publishing them
- **Clean Structure**: Centralized configuration and tooling across packages
- **Better Dev Experience**: Easier refactoring, testing, and CI/CD setup


## Key Features

- **Built-in Monorepo Support**: No need for extra tools like Lerna.
- **Workspace Protocol (`workspace:`)**: Ensures local packages are linked directly.
- **Efficient Dependency Management**: Shared dependencies are hoisted to the root, reducing duplication.
- **Running Scripts**: Run commands across all packages.
- **Strict Resolution**: Prevents phantom dependencies by enforcing exact matches.
- **Publishing Support**: Automatically replaces `workspace:` references with actual versions during publish.


## How It Work?

PNPM uses a `pnpm-workspace.yaml` file at the root of your repo to define which folders contain packages.

Each package has its own `package.json`, and dependencies between them can be linked using the `workspace:` protocol.

PNPM installs dependencies for all workspace packages in a single `node_modules` folder at the root.

If one package depends on another in the workspace, PNPM links them locally using symlinks. This allows changes in one package are instantly available to others, no need to publish to npm registry or reinstall.

_For example, using below configuration, every directory with a `package.json` in the `apps` or `packages` directories will be considered a package:_

```yaml title="pnpm-workspace.yaml"
packages:
  - "apps/*"
  - "packages/*"
```


## Creating Workspace

Use a monorepo tool like Turborepo or Nx to quickly scaffold a workspace. Configure them to use PNPM as the package manager.


## Install dependencies

Install dependencies in multiple packages:

```sh
pnpm add jest --save-dev --recursive --filter=web --filter=@repo/ui --filter=docs
```
- `--recursive` run command in every project of a workspace
- `--filter` run command in specific projects


## Linking internal packages

To link a package in the workspace, in the consumer package, run:

```sh
pnpm add @your-org/utils --workspace
```

This adds a reference to the consumer's `package.json`:

```json title="apps/web/package.json"
"dependencies": {
  "@your-org/utils": "workspace:*"
}
```

You can also specify the exact versions of the dependencies:
```json
"@your-org/utils": "workspace:^1.0.0"
```

> [!NOTE]
> The version is defined using the `version` field in `package.json` file of the source package.


## Running scripts

To run a script of a specific package:

```bash
pnpm --filter <package-name> run <script-name>
```

> [!INFO]
> Package name is defined using the `name` field in `package.json`

This runs the `build` script defined in `apps/web-app/package.json`:
```bash
pnpm --filter web-app run build
```

To run a script across **all packages** in the workspace:

```bash
pnpm -r run <script-name>
```

Run in all packages under `apps/`:
```bash
pnpm --filter 'apps/**' run dev
```

Run in packages that depend on `utils`:
```bash
pnpm --filter '...utils' run build
```

Use `pnpm exec` to run binaries from dependencies:
```bash
pnpm --filter web-app exec jest
```