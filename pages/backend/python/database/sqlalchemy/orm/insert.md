# Inserting Data

## Inserting a single object

```py
cc_cookie = Cookie(cookie_name='chocolate chip',
                   cookie_recipe_url='http://some.aweso.me/cookie/recipe.html',
                   cookie_sku='CC01',
                   quantity=12,
                   unit_cost=0.50)
session.add(cc_cookie)
session.commit()
```

Getting value of Autogenerated primary key:

```py
cc_cookie.cookie_id
```

- When we create the instance of the `Cookie` class and then add it to the session, nothing is sent to the database.
- When `commit()` is called, the following happens:
  - a transaction is started.
  - record is inserted into the database
  - the transaction is committed


## Adding related objects

```py
o1 = Order()
o1.user = cookiemon
session.add(o1)

cc = session.query(Cookie) \
  .filter(Cookie.cookie_name == "chocolate chip") \
  .one()
line1 = LineItem(cookie=cc, quantity=2, extended_cost=1.00)

pb = session.query(Cookie) \
  .filter(Cookie.cookie_name == "peanut butter") \
  .one()
line2 = LineItem(quantity=12, extended_cost=3.00)
line2.cookie = pb
line2.order = o1

o1.line_items.append(line1)
o1.line_items.append(line2)
session.commit()
```


## Inserting multiple records

```py
dcc = Cookie(cookie_name='dark chocolate chip',
             cookie_recipe_url='http://some.aweso.me/cookie/recipe_dark.html',
             cookie_sku='CC02',
             quantity=1,
             unit_cost=0.75)
mol = Cookie(cookie_name='molasses',
             cookie_recipe_url='http://some.aweso.me/cookie/recipe_molasses.html',
             cookie_sku='MOL01',
             quantity=1,
             unit_cost=0.80)
session.add(dcc)
session.add(mol)
session.flush()

print(dcc.cookie_id)
print(mol.cookie_id)
```

- We use `flush()` to save changes to database but don't end the transaction (it can still be rolled back).
- This results in two insert statements being sent to the database inside a single transaction.


## Bulk insert

Bulk inserting multiple records using a single insert statement:
```py
c1 = Cookie(cookie_name='peanut butter',
            cookie_recipe_url='http://some.aweso.me/cookie/peanut.html',
            cookie_sku='PB01',
            quantity=24,
            unit_cost=0.25)
c2 = Cookie(cookie_name='oatmeal raisin',
            cookie_recipe_url='http://some.okay.me/cookie/raisin.html',
            cookie_sku='EWW01',
            quantity=100,
            unit_cost=1.00)

session.bulk_save_objects([c1,c2])
session.commit()
```

- Faster than performing multiple individual session adds
- Relationship settings and actions are not respected or triggered.
- The objects are not connected to the session.
- Fetching primary keys is not done by default.
- No events will be triggered.
- Great when you want to insert data into the table and you don't need to perform additional work on that data.


## `flush()` vs. `commit()`

### `flush()`

- synchronizes the session with the database, but does not commit the changes
- it sends all pending changes to the database, allowing you to query the database and see the effects of those changes
- changes are still in a transaction that can be rolled back.
  
### `commit()`

- permanently saves the changes to the database, end the transaction
- also flushes out changes to the database before ending the transaction.
- the changes are visible to other sessions and transactions.


### Example

```py
# Create a new session
s = Session()

# Add a new user to the session
s.add(User(name="Alice"))

# The user is not in the database yet, but is returned by the query
print(s.query(User).all()) # [<User(name='Alice')>]

# Commit the changes to the database
s.commit()

# The user is now in the database and visible to other sessions
s2 = Session()
print(s2.query(User).all()) # [<User(name='Alice')>]

# Add another user to the session
s.add(User(name="Bob"))

# The user is not in the database yet, but is returned by the query
print(s.query(User).all()) # [<User(name='Alice')>, <User(name='Bob')>]

# Flush the changes to the database, but do not commit them
s.flush()

# The user is in the database, but not committed yet
print(s2.query(User).all()) # [<User(name='Alice')>]

# Roll back the changes
s.rollback()

# The user is no longer in the session or the database
print(s.query(User).all()) # [<User(name='Alice')>]
print(s2.query(User).all()) # [<User(name='Alice')>]
```
